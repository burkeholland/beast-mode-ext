<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="Content-Security-Policy" content="%%CSP%%" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beast Mode Settings</title>
  <style>
    /* Base */
    :root {
      color-scheme: light dark;
    }

    body {
      font-family: var(--vscode-font-family);
      color: var(--vscode-foreground);
      padding: 8px 10px 24px;
      font-size: 12.5px;
    }

    h1 {
      font-size: 14px;
      margin: 4px 0 12px;
      letter-spacing: .2px;
    }

    h2 {
      font-size: 11px;
      font-weight: 700;
      margin: 16px 0 6px;
      text-transform: uppercase;
      opacity: .75;
      letter-spacing: .6px;
    }

    .section {
      margin-bottom: 24px;
    }

    .section+.section {
      margin-top: 12px;
      padding-top: 14px;
      border-top: 1px solid var(--vscode-tree-indentGuidesStroke, var(--vscode-widget-border, transparent));
    }

    /* List layout (no boxes) */
    .settings-list {
      position: relative;
      border: none;
      border-radius: 0;
      background: transparent;
      overflow: visible;
    }

    .setting {
      display: grid;
      grid-template-columns: 1fr auto;
      align-items: center;
      column-gap: 14px;
      row-gap: 6px;
      padding: 12px 2px;
    }

    .setting:hover {
      background: var(--vscode-list-hoverBackground);
    }

    .setting-main {
      min-width: 0;
    }

    .setting-main label {
      font-weight: 600;
      display: inline-block;
      margin-bottom: 2px;
    }

    .setting-main .heading {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .info {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      font-size: 11px;
      line-height: 16px;
      color: var(--vscode-foreground);
      background: var(--vscode-widget-shadow, rgba(127, 127, 127, .12));
      border: 1px solid var(--vscode-widget-border, transparent);
      opacity: .8;
      cursor: default;
    }

    .info:hover {
      opacity: 1;
    }

    .desc {
      font-size: 11.5px;
      opacity: .78;
      line-height: 1.35;
    }

    /* Right-side controls */
    .setting-right {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      min-width: 120px;
    }

    .setting-main .control {
      display: block;
      margin-top: 8px;
    }

    /* Inputs */
    .control,
    .select-control {
      box-sizing: border-box;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border, var(--vscode-widget-border));
      border-radius: 6px;
      height: 24px;
      outline: none;
    }

    input[type=text].control,
    input[type=number].control {
      width: 180px;
      max-width: 40vw;
      padding: 2px 8px;
    }

    /* Make numeric stepper proportionate */
    input[type=number].control {
      width: 120px;
      min-width: 90px;
    }

    select.select-control {
      padding: 2px 6px;
      height: 24px;
      border-radius: 4px;
    }

    input[type=number]:focus,
    input[type=text]:focus,
    textarea:focus,
    select:focus {
      border-color: var(--vscode-focusBorder);
      box-shadow: 0 0 0 1px var(--vscode-focusBorder);
    }

    textarea {
      width: 100%;
      max-width: 100%;
      min-height: 84px;
      resize: vertical;
      background: var(--vscode-input-background);
      color: var(--vscode-input-foreground);
      border: 1px solid var(--vscode-input-border, var(--vscode-widget-border));
      border-radius: 6px;
      padding: 8px 10px;
      outline: none;
      font-family: var(--vscode-editor-font-family, monospace);
      font-size: 12px;
      line-height: 1.45;
    }

    textarea.invalid {
      border-color: var(--vscode-inputValidation-errorBorder);
      box-shadow: 0 0 0 1px var(--vscode-inputValidation-errorBorder);
    }

    input.number-invalid {
      border-color: var(--vscode-inputValidation-errorBorder);
      box-shadow: 0 0 0 1px var(--vscode-inputValidation-errorBorder);
    }

    /* Toggle */
    .switch {
      position: relative;
      display: inline-block;
      width: 38px;
      height: 22px;
      flex-shrink: 0;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      inset: 0;
      cursor: pointer;
      background: var(--vscode-input-background);
      transition: .18s ease;
      border: 1px solid var(--vscode-input-border, var(--vscode-widget-border));
      border-radius: 22px;
      box-sizing: border-box;
    }

    .slider:before {
      content: "";
      position: absolute;
      height: 16px;
      width: 16px;
      left: 2px;
      top: 2px;
      background: var(--vscode-editor-background, #fff);
      transition: .18s ease;
      border-radius: 50%;
      box-shadow: 0 1px 2px rgba(0, 0, 0, .25);
    }

    .switch input:focus+.slider {
      outline: 1px solid var(--vscode-focusBorder);
    }

    .switch input:checked+.slider {
      background: var(--vscode-button-background, var(--vscode-statusBarItem-prominentBackground));
      border-color: var(--vscode-button-border, var(--vscode-button-background));
    }

    .switch input:checked+.slider:before {
      transform: translateX(16px);
    }

    .switch input:active+.slider:before {
      width: 17px;
    }

    /* Keybindings */
    .keybinding-list .setting-main label {
      margin: 0;
    }

    kbd {
      font: 11px/1 var(--vscode-font-family);
      background: var(--vscode-editor-background);
      padding: 3px 7px;
      border: 1px solid var(--vscode-widget-border);
      border-radius: 6px;
    }

    /* Buttons */
    button.inline {
      background: transparent;
      color: var(--vscode-textLink-foreground);
      border: none;
      border-radius: 4px;
      height: 24px;
      padding: 0 2px;
      cursor: pointer;
      text-decoration: none;
    }

    button.inline:hover {
      text-decoration: underline;
    }

    /* Overlay */
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 8px;
      background: rgba(0, 0, 0, .25);
      backdrop-filter: blur(1px);
    }

    .overlay-card {
      background: var(--vscode-editor-background);
      color: var(--vscode-foreground);
      border: 1px solid var(--vscode-widget-border);
      border-radius: 8px;
      padding: 10px 12px;
      display: flex;
      gap: 10px;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .25);
      max-width: 90%;
    }

    .overlay-card .msg {
      font-size: 12px;
      opacity: .9;
    }

    .overlay-card button {
      height: 26px;
      background: var(--vscode-button-background);
      color: var(--vscode-button-foreground);
      border: 1px solid var(--vscode-button-border, transparent);
      border-radius: 6px;
      padding: 0 10px;
    }
  </style>
</head>

<body>
  <h1>Beast Mode Configuration</h1>
  <div id="settingsContainer" role="region" aria-label="Settings"></div>
  <div class="section">
    <h2>Keybindings</h2>
    <div class="settings-list keybinding-list" id="keybindingsContainer" role="region" aria-label="Keybindings"></div>
  </div>

  <script type="application/json" id="initialState" nonce="%%NONCE%%">%%STATE_JSON%%</script>
  <script nonce="%%NONCE%%">
    ; (() => {
      // VS Code webview API
      const vscode = acquireVsCodeApi();

      /** Utilities **/
      /** @template T */
      const debounce = (fn, wait = 300) => {
        let t;
        return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), wait); };
      };

      const $ = (sel, root = document) => /** @type {HTMLElement|null} */(root.querySelector(sel));

      /** Create element helper */
      const el = (tag, attrs = {}, children = []) => {
        const node = document.createElement(tag);
        for (const [k, v] of Object.entries(attrs)) {
          if (k === 'className') node.className = String(v);
          else if (k === 'dataset' && v && typeof v === 'object') Object.assign(node.dataset, v);
          else if (k in node) node[k] = v;
          else node.setAttribute(k, String(v));
        }
        for (const child of Array.isArray(children) ? children : [children]) {
          if (child == null) continue;
          node.appendChild(typeof child === 'string' ? document.createTextNode(child) : child);
        }
        return node;
      };

      const safeParseJSON = (text) => {
        try { return text ? JSON.parse(text) : null; } catch { return null; }
      };

      /** Typedefs (for editors) */
      /**
       * @typedef {{ key:string,title?:string,description:string,type:'boolean'|'number'|'string'|'json', group?:string, min?:number, step?:number, options?:{value:string,label?:string}[], info?:string, missingExtensions?:string[] }} SettingDef
       * @typedef {{ command:string, title:string, current?:string }} KeybindingItem
       * @typedef {{ settings: Record<string, any>, definitions: SettingDef[], groups: string[], keybindings: KeybindingItem[] }} SettingsState
       */

      // State
      const stateEl = /** @type {HTMLScriptElement|null} */ (document.getElementById('initialState'));
      /** @type {SettingsState} */
      let currentState = safeParseJSON(stateEl?.textContent || '') || { settings: {}, definitions: [], groups: [], keybindings: [] };

      /** DOM roots */
      const settingsRoot = /** @type {HTMLElement} */($('#settingsContainer'));
      const keybindingsRoot = /** @type {HTMLElement} */($('#keybindingsContainer'));

      /** Compute common missing extension IDs across defs in a group */
      const computeCommonMissing = (defs) => {
        if (!defs.length) return [];
        const base = new Set(defs[0].missingExtensions || []);
        for (let i = 1; i < defs.length; i++) {
          const next = new Set(defs[i].missingExtensions || []);
          for (const id of Array.from(base)) {
            if (!next.has(id)) base.delete(id);
          }
        }
        return Array.from(base);
      };

      /** Build a stable, valid id from a setting key */
      const idFromKey = (key) => `setting-${key.replace(/[^a-z0-9\-_.]/gi, '-')}`;

      /** Post helpers */
      const postUpdate = (key, value) => vscode.postMessage({ type: 'updateSetting', key, value });
      const postInstall = (ids) => vscode.postMessage({ type: 'installExtensions', ids });
      const postOpenKb = (command) => vscode.postMessage({ type: 'openKeybindings', command });

      /** Controls factory **/
      const makeSelect = (def, value, disabled) => {
        const select = /** @type {HTMLSelectElement} */(el('select', { className: 'select-control', disabled }));
        for (const opt of def.options || []) {
          const o = el('option', { value: opt.value }, opt.label || opt.value);
          if (String(value) === opt.value) o.setAttribute('selected', 'true');
          select.appendChild(o);
        }
        select.addEventListener('change', () => postUpdate(def.key, select.value));
        return select;
      };

      const makeToggle = (def, value, disabled) => {
        const wrap = el('label', { className: 'switch control', role: 'switch', 'aria-checked': !!value });
        const input = /** @type {HTMLInputElement} */(el('input', { type: 'checkbox', checked: !!value, disabled, 'aria-label': def.title || def.key }));
        const slider = el('span', { className: 'slider' });
        input.addEventListener('change', () => { wrap.setAttribute('aria-checked', String(input.checked)); postUpdate(def.key, input.checked); });
        wrap.appendChild(input); wrap.appendChild(slider);
        return wrap;
      };

      const makeNumber = (def, value, disabled) => {
        const input = /** @type {HTMLInputElement} */(el('input', { className: 'control', type: 'number', value: value ?? '', min: def.min, step: def.step, inputMode: 'numeric', disabled, id: idFromKey(def.key) }));
        const onInput = () => {
          const num = Number(input.value);
          if (!Number.isInteger(num) || (def.min !== undefined && num < def.min)) {
            input.classList.add('number-invalid');
            return;
          }
          input.classList.remove('number-invalid');
          postUpdate(def.key, num);
        };
        input.addEventListener('input', debounce(onInput, 300));
        return input;
      };

      const makeText = (def, value, disabled) => {
        const input = /** @type {HTMLInputElement} */(el('input', { className: 'control', type: 'text', value: value ?? '', disabled, id: idFromKey(def.key) }));
        input.addEventListener('input', debounce(() => postUpdate(def.key, input.value), 400));
        return input;
      };

      const makeJSON = (def, value, disabled) => {
        const area = /** @type {HTMLTextAreaElement} */(el('textarea', { className: 'control', disabled, id: idFromKey(def.key) }));
        try { area.value = JSON.stringify(value ?? null, null, 2); } catch { area.value = 'null'; }
        const onInput = () => {
          try { const parsed = JSON.parse(area.value); area.classList.remove('invalid'); postUpdate(def.key, parsed); }
          catch { area.classList.add('invalid'); }
        };
        area.addEventListener('input', debounce(onInput, 500));
        return area;
      };

      /** Rendering **/
      const render = () => {
        // Settings groups
        settingsRoot.innerHTML = '';
        const frag = document.createDocumentFragment();
        for (const group of currentState.groups) {
          const section = el('div', { className: 'section', role: 'region', 'aria-label': group });
          section.appendChild(el('h2', {}, group));
          const list = el('div', { className: 'settings-list' });
          const defs = currentState.definitions.filter(d => d.group === group);
          for (const def of defs) list.appendChild(renderSetting(def));
          section.appendChild(list);

          const commonMissing = computeCommonMissing(defs);
          if (commonMissing.length) {
            const overlay = el('div', { className: 'overlay' });
            const card = el('div', { className: 'overlay-card' });
            const msg = el('div', { className: 'msg' }, `Requires extension${commonMissing.length > 1 ? 's' : ''}: ${commonMissing.join(', ')}`);
            const btn = el('button', { className: 'inline', type: 'button' }, 'Install');
            btn.addEventListener('click', () => postInstall(commonMissing));
            card.appendChild(msg); card.appendChild(btn); overlay.appendChild(card); list.appendChild(overlay);
          }

          frag.appendChild(section);
        }
        settingsRoot.appendChild(frag);

        // Keybindings
        renderKeybindings();
      };

      const renderSetting = (def) => {
        const value = currentState.settings[def.key];
        const row = el('div', { className: 'setting' });
        const main = el('div', { className: 'setting-main' });

        const labelId = idFromKey(def.key) + '-label';
        const label = el('label', { id: labelId, htmlFor: idFromKey(def.key) }, def.title || def.key.split('.').slice(-1)[0]);
        const heading = el('div', { className: 'heading' }, [label]);
        if (def.info) {
          heading.appendChild(el('span', { className: 'info', title: def.info, 'aria-label': def.info }, 'i'));
        }
        main.appendChild(heading);
        main.appendChild(el('div', { className: 'desc' }, def.description));

        const missing = Array.isArray(def.missingExtensions) ? def.missingExtensions : [];
        if (missing.length) {
          const warn = el('div', { className: 'desc', style: 'color: var(--vscode-inputValidation-warningForeground, #d19a66);' }, `Requires extension${missing.length > 1 ? 's' : ''}: ${missing.join(', ')}`);
          main.appendChild(warn);
        }

        row.appendChild(main);
        const right = el('div', { className: 'setting-right' });
        const disabled = missing.length > 0;

        if (Array.isArray(def.options) && def.options.length) {
          right.appendChild(makeSelect(def, value, disabled));
        } else if (def.type === 'boolean') {
          right.appendChild(makeToggle(def, value, disabled));
        } else if (def.type === 'number') {
          right.appendChild(makeNumber(def, value, disabled));
        } else if (def.type === 'json') {
          // JSON editor spans full width under description
          main.appendChild(makeJSON(def, value, disabled));
        } else {
          right.appendChild(makeText(def, value, disabled));
        }

        if (missing.length) {
          const btn = el('button', { className: 'inline', type: 'button' }, 'Install');
          btn.addEventListener('click', () => postInstall(missing));
          right.appendChild(btn);
        }

        row.appendChild(right);
        return row;
      };

      const renderKeybindings = () => {
        keybindingsRoot.innerHTML = '';
        const frag = document.createDocumentFragment();
        for (const kb of currentState.keybindings) {
          const row = el('div', { className: 'setting' });
          const main = el('div', { className: 'setting-main' });
          main.appendChild(el('label', {}, kb.title));
          main.appendChild(el('div', { className: 'desc' }, kb.command));
          row.appendChild(main);
          const right = el('div', { className: 'setting-right' });
          right.appendChild(el('kbd', {}, kb.current || 'Unassigned'));
          const btn = el('button', { className: 'inline', type: 'button' }, 'Change');
          btn.addEventListener('click', () => postOpenKb(kb.command));
          right.appendChild(btn);
          row.appendChild(right);
          frag.appendChild(row);
        }
        keybindingsRoot.appendChild(frag);
      };

      // Initial render
      render();
    })();
  </script>
</body>

</html>